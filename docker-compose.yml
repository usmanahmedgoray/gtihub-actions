# Name of the application
name: github-actions

# Docker Compose version
version: '3.8'

# Networks
networks:
  app:
    driver: bridge

# Volumes
volumes:
  node-modules:
    driver: local

# Services
services:
  api:
    # Build the image from the Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
      # target: production

    # Set container name
    container_name: github-actions-api

    # Expose the port
    ports:
      - "2000:2000"

    # Set environment variables
    environment:
      - NODE_ENV=production
      - PORT=2000

    # Load environment variables from .env file
    env_file:
      - .env

    # Connect to the app network
    networks:
      - app

    # Mount the node modules volume
    volumes:
      - node-modules:/app/node_modules
      - .:/app

    # Restart policy
    restart: unless-stopped

    # Health check to verify container is running properly
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://${HEALTH_HOST:-localhost}:${PORT:-2000}/healthz >/dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Run the application
    command: [ "npm", "run", "dev" ]
